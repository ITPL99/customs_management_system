# Техническое Задание: Глобальная Платформа Управления Таможней

**Уровень детализации: 10/10**

## 1. Введение и Суть Проекта

**Название проекта:** "Aegis: Global Trade Facilitation Platform"

**Цель:** Разработать единую цифровую платформу для гармонизации и автоматизации таможенных процедур в рамках **международного торгового союза**. Система должна служить единым окном для всех участников внешнеэкономической деятельности (ВЭД) — импортеров, экспортеров, перевозчиков и брокеров — для ведения трансграничной торговли между странами-участницами.

**Ключевые особенности:**
*   **Единый реестр участников ВЭД:** Глобальная регистрация и верификация компаний, перевозчиков и брокеров.
*   **Динамический тарифный движок:** Автоматический расчет пошлин с учетом страны происхождения, страны назначения и действующих между ними **торговых соглашений**.
*   **Управление юрисдикциями:** Возможность добавлять новые страны в союз и настраивать их национальные правила.
*   **Полная прослеживаемость грузов** на всех этапах трансграничного перемещения.

---

## 2. Технологический стек (без изменений)

---

## 3. Вариант 1: Детализированный Монолит

### 3.1. Функциональные требования

#### 3.1.1. Модуль "Глобальный Реестр и Доступ"
*   **Роли:** `UNION_ADMIN` (Администратор Союза), `CUSTOMS_OFFICER` (Инспектор, привязан к конкретной стране), `COMPANY_ADMIN` (Представитель компании-участника ВЭД), `CARRIER_ADMIN` (Представитель перевозчика), `CUSTOMS_BROKER`.
*   `UNION_ADMIN` управляет списком `Стран-участниц` и `Торговыми соглашениями` между ними.
*   `COMPANY_ADMIN` и `CARRIER_ADMIN` регистрируют свои организации в системе, проходя процедуру верификации.

#### 3.1.2. Модуль "Международное Тарифное Регулирование"
*   `UNION_ADMIN` вносит в систему `Торговые соглашения`, которые могут устанавливать льготные ставки пошлин между странами.
*   Система содержит `Национальные справочники ТН ВЭД` для каждой страны-участницы.
*   **Тарифный движок** при расчете пошлин учитывает: 1) Базовую ставку страны-импортера; 2) Наличие льготной ставки по торговому соглашению.

#### 3.1.3. Модуль "Обработка Трансграничных Деклараций"
*   `CUSTOMS_BROKER` (действуя от имени `Компании`) подает `Грузовую декларацию`, **обязательно указывая страну происхождения и страну назначения**.
*   Система автоматически направляет декларацию в юрисдикцию **страны-назначения** и назначает инспектора из этой страны.
*   Система оценки рисков анализирует не только товар и участников, но и **торговый маршрут**.

#### 3.1.4. Модуль "Досмотр и Контроль" (без концептуальных изменений)
*   Проводится инспектором страны-назначения по ее внутренним правилам (красный/зеленый коридор).

#### 3.1.5. Модуль "Финансовые Операции и Выпуск"
*   Система выставляет счет на оплату пошлин в валюте **страны-назначения**.
*   После оплаты разрешение на выпуск генерируется для таможенного поста и склада в **стране-назначения**.

### 3.2. Детализированная структура сущностей
*   `User`, `Company`, `Carrier`, `CustomsBroker` (профили участников ВЭД).
*   `Country` (id, name, currency, customs_regulations_json).
*   `TradeAgreement` (id, country_a_id, country_b_id, details_json).
*   `TariffRule` (id, country_id, hs_code, base_duty_rate, preferential_duty_rate, agreement_id).
*   `CargoDeclaration` (id, broker_id, company_id, carrier_id, **origin_country_id**, **destination_country_id**, status).
*   Остальные сущности (`DeclaredItem`, `Inspection`, `DutyInvoice`) остаются, но теперь логически привязаны к юрисдикции страны-назначения.

### 3.3. Детализированный список эндпоинтов

**UnionAdminController (`/api/union-admin/**`):**
*   `/countries` (CRUD), `/trade-agreements` (CRUD).

**CompanyController (`/api/company/**`):**
*   `/register` (POST), `/profile` (GET, PUT).

**BrokerController (`/api/broker/**`):**
*   `/declarations` (POST - подать декларацию с указанием стран).

**OfficerController (`/api/officer/{countryCode}/**`):**
*   `/declarations/queue` (GET - получить декларации, адресованные в твою страну).

---

# 4. Алгоритмы и Сценарии Использования Системы (Aegis Global)

---

## 4.1. Сценарий: Торговля внутри союза по льготной ставке
1.  **Действие:** `UNION_ADMIN` вносит в систему торговое соглашение между Германией и Польшей, обнуляющее пошлины на автозапчасти.
2.  **Эндпоинт:** `POST /api/union-admin/trade-agreements`
3.  **Действие:** Немецкая компания (`COMPANY_ADMIN`) регистрируется в системе. Польский перевозчик (`CARRIER_ADMIN`) тоже.
4.  **Действие:** Брокер (`CUSTOMS_BROKER`), нанятый немецкой компанией, подает декларацию на ввоз автозапчастей из Германии в Польшу.
5.  **Эндпоинт:** `POST /api/broker/declarations` (с `origin_country`=DE, `destination_country`=PL).
6.  **Результат:** Тарифный движок видит маршрут DE->PL, находит торговое соглашение и применяет льготную (нулевую) ставку. Система выставляет счет только на оплату НДС по польскому законодательству. Декларация получает `GREEN` коридор и выпускается автоматически после оплаты.

## 4.2. Сценарий: Торговля с третьей страной по базовой ставке
1.  **Действие:** Та же немецкая компания ввозит электронику из Китая (не входит в союз) в Германию.
2.  **Эндпоинт:** `POST /api/broker/declarations` (с `origin_country`=CN, `destination_country`=DE).
3.  **Результат:** Тарифный движок не находит торгового соглашения между CN и DE. Он применяет базовую ставку пошлин, установленную в Германии для данной категории товаров. Система оценки рисков присваивает `YELLOW` коридор (документарная проверка). Инспектор в Германии проверяет документы и после оплаты пошлин выпускает груз.

---

## 5. Вариант 2: Микросервисная Архитектура

1.  **Registry-Service:** Управляет глобальным реестром компаний, перевозчиков и брокеров.
2.  **Compliance-Service (НОВЫЙ):** Управляет странами, торговыми соглашениями и национальными правилами.
3.  **Tariff-Engine-Service (НОВЫЙ):** Сложный сервис, который по запросу `(товар, откуда, куда)` обращается к `Compliance-Service` и возвращает корректную ставку пошлины.
4.  **Declaration-Processing-Service:** Оркестратор, который принимает декларацию и последовательно обращается к другим сервисам (Risk, Tariff, Billing) для ее обработки.
